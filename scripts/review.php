<!-- 
  LEGAL NOTICE

  This project serves as a teaching example or sample solution in the 
  context of teaching, to teach knowledge in software development. 
  It contains a software solution.

  Please check the LICENSE OF THIS PROJECT below, to find the license 
  information for this project. This license is just related to the 
  contained software solution and its source code, as far as the 
  software solution was developed by the copyright holder.
  This license bases on [bsd-3], but some modifications make it 
  different from regular BSD-Licences. 

  Errors, changes and deviations are not impossible!

  The project was developed and tested with the software 
  [Apache 2.4 VS17] in connexion with [php 8.1.12].
  [Apache 2.4 VS17] and [php 8.1.12] will not be delivered/distributed 
  as parts of this project. 

  The project uses elements of 
  [Bootstrap 5.2.3], [Font Awesome 5.15.3], 
  [@thelaazyguy, Css Button Hover #2 - Background] and 
  [@allenhe, 5 star rating with css and html].
  Furthermore basic functionalities of the operating system
  Microsoft Windows 10 (Version 10.0.19044.2251) were used
  in order to create this project. Especially the functionality 
  of "Microsoft Print to PDF" or the editor "notepad" were used.
  
LICENSE OF THIS PROJECT

  This license bases on [bsd-3] with fundamental modifications:

  Copyright 2022 Slaven Mlinaric, Leon Rausch, Yannick Diehl, IU University of Applied Sciences, 
  Darmstädter Landstraße 110, 60598 Frankfurt am Main, Germany

  The use of this project is only allowed in the context of 
  the lecture to facilitate the understanding of programming 
  techniques. Redistribution and use in source or binary forms, with 
  or without modification, are not allowed. 

  DISCLAIMER [bsd-3]: 
   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
   "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT 
   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
   FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE 
   COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, 
   INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, 
   BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
   CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT 
   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN 
   ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
   POSSIBILITY OF SUCH DAMAGE.

REFERENCES

  [bsd-3] Open Source Initiative (n. Y.): "The 3-Clause BSD License". 
     URL: https://opensource.org/licenses/BSD-3-Clause, 
     accessed 2023-FEB-01.
  [Apache 2.4 VS17] Apache Lounge powered by Apache (2021): 
     "Apache 2.4 VS17 Windows Binaries and Modules". Version 2.4.54 Win64. 
     Online available at URL: https://www.apachelounge.com/download/, 
     accessed 2023-FEB-01. 
     [License-URL: https://www.apachelounge.com/contact.html].
  [php 8.1.12] The PHP Group (2022): "PHP: Hypertext Preprocessor". 
     Version 8.1.12. Online available at 
     URL: https://windows.php.net/download/, accessed 2023-FEB-01. 
     [License: PHP License v3.01, 
     License-URL: https://www.php.net/license/3_01.txt].
  [Bootstrap 5.2.3] Mark Otto / Jacob Thornton / XhmikosR / GeoSot / 
     Rohit Sharma / alpadev / Gael Poupard / Patrick H. Lauke /
     Martijn Cuppend / Johann-S / Gleb Mazovetskiy (2022): "Bootstrap".
     Version 5.2.3. Bootstrap is released under the MIT license 
     and is copyright 2022 Twitter. Online available at
     URL: https://getbootstrap.com/, accessed 2023-FEB-01.
     [Bootstrap v5.2.3 (https://getbootstrap.com/), 
     Copyright 2011-2022 The Bootstrap Authors, 
     Copyright 2011-2022 Twitter, Inc., 
     Licensed under MIT 
     (https://github.com/twbs/bootstrap/blob/main/LICENSE)].
  [Font Awesome 5.15.3]  Fonticons, Inc. (2022): "Font Awesome".
     Version 5.15.3. Online available at
     URL: https://fontawesome.com, accessed 2023-FEB-01.
     [Font Awesome v5.15.3 (https://fontawesome.com),
     Copyright 2022 Fonticons, Inc.,
     Licensed under MIT (https://fontawesome.com/license/free).]
  [JQuery 3.5.1] OpenJS Foundation and jQuery contributors (2022): "JQuery".
     Version 3.5.1. slim
     Online available on the website of jqeury.com at URL: https://code.jquery.com/jquery-3.5.1.slim.min.js,
     accessed 2023-FEB-01.
     [JQuery v3.5.1 (https://code.jquery.com/jquery-3.5.1.slim.min.js),
     Copyright 2023 OpenJS Foundation and jQuery contributors,
     Licensed under MIT (https://jquery.org/license).]
  [@thelaazyguy, Css Button Hover #2 - Background], Author unbekannt(pseudonym: @thelaazyguy) (2017):
     Online available on the website of https://codepen.io/ at
     URL: https://codepen.io/thelaazyguy/pen/brryVq 
     accessed 2023-FEB-01.
     [@thelaazyguy, Css Button Hover #2 - Background
     Licensed under MIT (https://codepen.io/thelaazyguy/details/brryVq)]
  [@allenhe, 5 star rating with css and html], Author unbekannt(pseudonym: @thelaazyguy) (2020):
     Online available on the website of https://codepen.io/ at
     URL: https://codepen.io/hesguru/pen/BaybqXv 
     accessed 2023-FEB-01.
     [@allenhe, 5 star rating with css and html
     Licensed under MIT (https://codepen.io/hesguru/details/BaybqXv)]

REMARKS

  The file "Bootstrap_License.txt" contains the licence of
  Bootstrap, obtained from the URL
  https://github.com/twbs/bootstrap/blob/main/LICENSE
  accessed on February 1st 2023.
  The file "Font_Awesome_License.txt" contains the license of 
  the used Icon-Font Font Awesome, obtained from the URL
  https://github.com/FortAwesome/Font-Awesome/blob/6.x/LICENSE.txt
  accessed on February 1st 2023.
  The file "Animated_CSS_Button_License.txt" contains the license of 
  the used Animated CSS Buttons, obtained from the URL
  https://codepen.io/thelaazyguy/details/brryVq
  accessed on February 1st 2023.
  The file "Five_Star_Rating.txt" contains the license of 
  the used Five Star Rating, obtained from the URL
  https://codepen.io/hesguru/details/BaybqXv
  accessed on February 1st 2023.

IMAGES
All images are from the same website https://www.themoviedb.org/
For readability reasons we have renamed the original files 
in the following the new name of the file is displayed in parentheses after each link
https://www.themoviedb.org/t/p/original/jRXYjXNq0Cs2TcJjLkki24MLp7u.jpg (Avatar.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/yu26pJwGFUyqTJWMWo1mMgBFJ0N.jpg (Forrest-Gump.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/8IB2e4r4oVhHnANbnm7O3Tj6tF8.jpg (Inception.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/gEU2QniE6E77NI6lCU6MxlNBvIx.jpg (Interstellar.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/lxM6kqilAdpdhqUl2biYp5frUxE.jpg (Jaws.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/z9abTHTUSRVktz9T12sqLJDUwaV.jpg (Pacific-Rim.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/fIE3lAGcZDV1G6XM5KmuWnNsPp1.jpg (Pulp-Fiction.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/eP5NL7ZlGoW9tE9qnCdHpOLH1Ke.jpg (The-Dark-Knight.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/3Tf8vXykYhzHdT0BtsYTp570JGQ.jpg (The-Godfather.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/sKCr78MXSLixwmZ8DyJLrpMsd15.jpg (The-Lion-King.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/f89U3ADr1oiB1s9GkdPOEpXUk5H.jpg (The-Matrix.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/pVHyB857pFAl9pBgOGzWTChPwlK.jpg (The-Shawshank-Redemption.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/rplLJ2hPcOQmkFhTqUte0MkEaO2.jpg (The-Silence-of-the-Lambs.jpg)
accessed on January 31st 2023
https://www.themoviedb.org/t/p/original/5bTWA20cL9LCIGNpde4Epc2Ijzn.jpg (Titanic.jpg)
accessed on January 31st 2023
 -->
<?php
include 'connect.php';

function validate($data)
{
    $data = trim($data);
    $data = stripslashes($data);
    $data = htmlspecialchars($data);
    $_SESSION["validation_activated"] = true;
    return $data;
}


// Get comments from the database
function getComments($dbConn, $movie_id) {
    try {
        $commentsQuery = "SELECT u.username, mc.comment, mc.created_at, mc.id, mc.user_id
        FROM public.\"Users\" u
        INNER JOIN public.\"movie_comments\" mc ON u.user_id = mc.user_id
        WHERE mc.movie_id = $movie_id ORDER BY mc.created_at DESC";
        $queryResult = pg_query($dbConn, $commentsQuery);
        $comments = pg_fetch_all($queryResult);
        return $comments;
    } catch(Exception $e) {
        echo $e->getMessage();
    }
  }
  
  // Get a movie rating 
  function getMovieRatingAvg($dbConn, $movie_id){
    try{
      $ratingQuery = "SELECT AVG(rating) AS avg_rating FROM public.\"movie_ratings\" WHERE movie_id = $movie_id";
      $queryResult = pg_query($dbConn, $ratingQuery);
      $rating = pg_fetch_assoc($queryResult);
      return $rating;
      
    } catch(Exception $e) {
      echo $e->getMessage();
    }
  }
  
  // Get movie rating from logged in user for the selected movie
  function getUserRatingForMovie($dbConn, $movieId, $user_id) {
    try{
      $query = "SELECT * FROM public.\"movie_ratings\" WHERE movie_id='$movieId' AND user_id='$user_id'";
      $queryResult = pg_query($dbConn, $query);
      return pg_fetch_assoc($queryResult);
    } catch(Exception $e) {
      echo $e->getMessage();
    }
  }

  //post for rating and comment
  if (isset($_POST['rate']) && isset($_POST['movie_id']) && isset($_POST['user_id'])) {
    
    $rate = $_POST['rate'];
    $movie_id = $_POST['movie_id'];
    $user_id = $_POST['user_id'];
    $existingRating = getUserRatingForMovie($dbConn, $movie_id, $user_id); 
    if (isset($_POST['comment'])) {
        $comment = validate($_POST['comment']);
        if(!empty($comment)){
          $insertComment = "INSERT INTO public.\"movie_comments\"(comment, movie_id, user_id, created_at) VALUES('$comment', '$movie_id', '$user_id', now())";
          $insertCommentResult = pg_query($dbConn, $insertComment);
         // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
          echo "
          <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
            Comment added successfully  
            <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
          </div>
          ";
        }
    }

    if (empty($existingRating)) {
        $insert = "INSERT INTO public.\"movie_ratings\"(rating, movie_id, user_id) VALUES('$rate', '$movie_id', '$user_id')";
        $insertResult = pg_query($dbConn, $insert);
        // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
        echo "
        <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
          Rating added successfully  
          <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
        </div>
      ";
    } else {
      $update = "UPDATE public.\"movie_ratings\" SET rating='$rate' WHERE movie_id='$movie_id' AND user_id='$user_id'";
      $updateResult = pg_query($dbConn, $update);
      // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
      echo "
      <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
        Rating updated successfully  
        <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
      </div>
      ";
    }
  }else if(!isset($_POST['rate']) && isset($_POST['comment'])){
    // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
    echo "
        <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
          You have to rate the movie in order to post a comment 
          <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
        </div>
        ";
  }

  //delete a comment
  function deleteComment($dbConn, $comment_id, $user_id) {
    try{
      $deleteQuery = "DELETE FROM public.\"movie_comments\" WHERE id = '$comment_id' AND user_id = '$user_id'";
      $deleteResult = pg_query($dbConn, $deleteQuery);
      return $deleteResult;
    } catch(Exception $e) {
      echo $e->getMessage();
    }
  }
  
  if(isset($_POST["delete"])) {
    $comment_id = $_POST['comment_id'];
    $user_id = $_SESSION['user_id'];
    $result = deleteComment($dbConn, $comment_id, $user_id);
    if ($result) {
      // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
      echo "
      <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
        Comment deleted successfully
        <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
      </div>
      ";
    }
  }
  
  // Update comment
  function updateComment($dbConn, $comment_id, $newComment, $user_id) {
    try{
      $updateQuery = "UPDATE public.\"movie_comments\" SET comment='$newComment', created_at= now() WHERE id = $comment_id AND user_id = '$user_id'";
      $updateResult = pg_query($dbConn, $updateQuery);
      return $updateResult;
    } catch(Exception $e) {
      echo $e->getMessage();
    }
  }
  
  if(isset($_POST["update"])) {
    $comment_id = intval($_POST['comment_id']);
    $new_comment = validate($_POST['new_comment_input']);
    $user_id = $_SESSION['user_id'];
    $result = updateComment($dbConn, $comment_id, $new_comment, $user_id);
    if ($result) {
      // Bezugnahme auf Design-Elemente von [Bootstrap 5.2.3].
      echo "
      <div class='alert alert-success alert-dismissible fade show text-center mx-auto my-auto' role='alert'>
        Comment updated successfully  
        <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
      </div>
      ";
    }
  }
  
?>